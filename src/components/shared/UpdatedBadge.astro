---
/**
 * UpdatedBadge.astro
 * Shows a green ripple badge when an article was modified within 72 hours (3 days).
 * Pure CSS animation â€” zero JS, zero performance impact.
 * Auto-hides after 72 hours without any code change needed.
 */
import { SITE } from "@/lib/config";

type Props = {
  lastModified: string | Date | null | undefined;
  publishedTime?: string | Date | null | undefined;
  hideBadge?: boolean;
  small?: boolean;
  corner?: boolean;
  latest?: boolean;
};

const { 
  lastModified, 
  publishedTime,
  hideBadge = false, 
  small = false, 
  corner = false, 
  latest = false 
} = Astro.props;

if (!lastModified || hideBadge) return;

const lastModifiedDate = new Date(lastModified);
const publishedDate = publishedTime ? new Date(publishedTime) : null;
const resetDate = new Date(SITE.badgeResetDate || 0);

const SEVENTY_TWO_HOURS_MS = 72 * 60 * 60 * 1000;
const RECENT_SAVE_THRESHOLD_MS = 15 * 1000; // 15 seconds to distinguish edit from initial publish

// Logic:
// 1. Must be within 72h window
const isWithinWindow = (Date.now() - lastModifiedDate.getTime()) < SEVENTY_TWO_HOURS_MS;

// 2. Must be after the global reset date
const isAfterReset = lastModifiedDate.getTime() > resetDate.getTime();

// 3. Must be an actual update (Modified time significantly after Published time)
const isActuallyUpdated = publishedDate 
  ? (lastModifiedDate.getTime() - publishedDate.getTime()) > RECENT_SAVE_THRESHOLD_MS
  : true;

// 4. Manual override: If user ticked "Hide Badge" in Keystatic, it stays hidden permanently for this version.
const isRecentlyUpdated = !hideBadge && isWithinWindow && isAfterReset && isActuallyUpdated;
---

{isRecentlyUpdated && (
  <span
    aria-label="Recently Updated"
    class={`absolute z-20 flex items-center justify-center ${small ? 'top-1.5 right-1.5' : corner ? 'top-1.5 right-1.5 scale-[0.83]' : latest ? 'top-2.5 right-2.5 scale-[0.93]' : 'top-3 right-3'}`}
  >
    {/* Ripple waves */}
    <span class={`absolute rounded-full bg-green-400 opacity-20 animate-[ripple_2.5s_ease-out_infinite] ${small ? 'w-1.5 h-1.5' : 'w-2 h-2'}`}></span>
    {!small && <span class="absolute rounded-full w-2 h-2 bg-green-400 opacity-10 animate-[ripple_2.5s_ease-out_0.8s_infinite]"></span>}
    {/* Solid green dot */}
    <span class={`relative rounded-full bg-green-500 animate-pulse ${small ? 'w-1.5 h-1.5' : 'w-2 h-2'}`}></span>
  </span>
)}


<style>
  @keyframes ripple {
    0% {
      transform: scale(1);
      opacity: 0.25;
    }
    100% {
      transform: scale(3.5);
      opacity: 0;
    }
  }
</style>
