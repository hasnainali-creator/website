---
import "@/styles/global.css";
import { ClientRouter } from "astro:transitions";
import { SITE } from "@/lib/config";
import type { ArticleMeta, Meta } from "@/lib/types";

type Props = {
  meta: Meta | ArticleMeta;
};

const { meta } = Astro.props;

// Type guard to check if props is ArticleMeta
const isArticleMeta = (props: Props["meta"]): props is ArticleMeta =>
  props.type === "article";
const canonicalURL = new URL(Astro.url.pathname, Astro.site).href;

import { categoriesHandler } from "@/lib/handlers/categories";
const catProvider = await categoriesHandler.getProvider();
const navCategories = catProvider.getNestedCategories();

const OGImage = new URL(meta.ogImage, Astro.url).href;

const schemaOrg: any = {
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "WebSite",
      "@id": `${Astro.site}#website`,
      "url": Astro.site,
      "name": SITE.title,
      "description": SITE.description,
      "publisher": {
        "@id": `${Astro.site}#organization`
      }
    },
    {
      "@type": "Organization",
      "@id": `${Astro.site}#organization`,
      "name": SITE.title,
      "url": Astro.site,
      "logo": {
        "@type": "ImageObject",
        "@id": `${Astro.site}#logo`,
        "url": new URL("favicon-96x96.png", Astro.site).href,
        "contentUrl": new URL("favicon-96x96.png", Astro.site).href,
        "width": 96,
        "height": 96,
        "caption": SITE.title
      },
      "image": {
        "@id": `${Astro.site}#logo`
      },
      "sameAs": [
        "https://instagram.com/omnysports",
        "https://twitter.com/omnysports",
        "https://facebook.com/omnysports",
        "https://tiktok.com/@omnysports"
      ],
      "contactPoint": {
        "@type": "ContactPoint",
        "contactType": "customer service",
        "url": new URL("contact", Astro.site).href,
        "email": "contact@omnysports.com"
      }
    }
  ]
};

if (isArticleMeta(meta)) {
  schemaOrg["@graph"].push({
    "@type": "NewsArticle",
    "@id": `${canonicalURL}#article`,
    "isPartOf": {
      "@id": `${Astro.site}#website`
    },
    "headline": meta.metaTitle,
    "datePublished": new Date(meta.publishedTime).toISOString(),
    "dateModified": new Date(meta.lastModified).toISOString(),
    "description": meta.description,
    "copyrightYear": new Date(meta.publishedTime).getFullYear(),
    "isAccessibleForFree": "True",
    "articleSection": meta.category?.[0] || "Sports News",
    "mainEntityOfPage": {
      "@id": canonicalURL
    },
    "image": {
        "@type": "ImageObject",
        "url": OGImage
    },
    "author": meta.authors.map((author) => ({
      "@type": "Person",
      "name": author.name,
      "url": new URL(`authors/${author.link}`, Astro.site).href,
    })),
    "publisher": {
      "@id": `${Astro.site}#organization`
    },
    "speakable": {
      "@type": "SpeakableSpecification",
      "cssSelector": [".article-headline", ".article-content"]
    }
  });
}

// SiteNavigationElement for rich sitelinks
schemaOrg["@graph"].push({
  "@type": "ItemList",
  "@id": `${Astro.site}#primary-navigation`,
  "name": "Primary Navigation",
  "itemListElement": [
    {
      "@type": "SiteNavigationElement",
      "position": 1,
      "name": "Home",
      "url": Astro.site
    },
    ...navCategories.map((cat, index) => ({
      "@type": "SiteNavigationElement",
      "position": index + 2,
      "name": cat.data.title,
      "url": new URL(`categories/${cat.id}/1`, Astro.site).href
    }))
  ]
});

const schemaOrgString = JSON.stringify(schemaOrg);

const breadcrumbSchema: any = meta.breadcrumbs ? {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": Astro.site
    },
    ...meta.breadcrumbs.map((crumb, index) => ({
      "@type": "ListItem",
      "position": index + 2,
      "name": crumb.label,
      "item": new URL(crumb.url, Astro.site).href
    }))
  ]
} : null;

const breadcrumbSchemaString = breadcrumbSchema ? JSON.stringify(breadcrumbSchema) : null;
---

<head>
  <!-- Global Metadata -->
  <meta charset={SITE.charset} />
  
  <!-- Font Architecture (Inlined definitions to eliminate CSS-to-Font chain) -->
  <link rel="preload" href="/fonts/source-sans-pro-latin-400-normal.woff2" as="font" type="font/woff2" crossorigin="anonymous" />
  <link rel="preload" href="/fonts/source-sans-pro-latin-600-normal.woff2" as="font" type="font/woff2" crossorigin="anonymous" />
  <link rel="preload" href="/fonts/source-sans-pro-latin-700-normal.woff2" as="font" type="font/woff2" crossorigin="anonymous" />
  <style is:inline>
    @font-face {
      font-family: "Source Sans Pro";
      font-style: normal;
      font-display: swap;
      font-weight: 400;
      src: url("/fonts/source-sans-pro-latin-400-normal.woff2") format("woff2");
    }
    @font-face {
      font-family: "Source Sans Pro";
      font-style: normal;
      font-display: swap;
      font-weight: 600;
      src: url("/fonts/source-sans-pro-latin-600-normal.woff2") format("woff2");
    }
    @font-face {
      font-family: "Source Sans Pro";
      font-style: normal;
      font-display: swap;
      font-weight: 700;
      src: url("/fonts/source-sans-pro-latin-700-normal.woff2") format("woff2");
    }
    @font-face {
      font-family: "Source Serif 4 Variable";
      font-style: normal;
      font-display: swap;
      font-weight: 200 900;
      src: url("/fonts/source-serif-4-latin-wght-normal.woff2") format("woff2-variations");
    }
  </style>

  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="generator" content={Astro.generator} />
  <meta name="google-site-verification" content="W8AjDFoqY6tOae7A9GdmvTwsRrApr2oONLXibkvtmR8" />

  <!-- Canonical URL -->
  <link rel="canonical" href={canonicalURL} />

  <!-- Page Metadata -->
  <title>{meta.title}</title>
  <meta name="title" content={meta.metaTitle} />
  <meta name="description" content={meta.description} />
  {meta.keywords && <meta name="keywords" content={meta.keywords} />}

  <!-- Essential SEO Robots for Google News -->
  <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1" />

  <!-- Favicons -->
  <link rel="icon" type="image/svg+xml" href="/favicon.svg?v=2" />
  <link rel="icon" type="image/png" href="/favicon-96x96.png?v=2" sizes="96x96" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png?v=2" />
  <meta name="apple-mobile-web-app-title" content={SITE.title} />
  <link rel="manifest" href="/site.webmanifest" />

  <!-- RSS & Sitemap -->
  <link rel="sitemap" href="/sitemap-index.xml" />
  <link
    rel="alternate"
    type="application/rss+xml"
    title={SITE.title}
    href={new URL("rss.xml", Astro.site)}
  />

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content={meta.type} />
  <meta property="og:url" content={canonicalURL} />
  <meta property="og:title" content={meta.metaTitle} />
  <meta property="og:description" content={meta.description} />
  <meta property="og:image" content={OGImage} />
  <meta property="og:image:alt" content={meta.ogImageAlt} />
  <meta property="og:site_name" content={SITE.title} />

  <!-- Twitter -->
  <meta property="twitter:site" content="@OmnySports" />
  <meta property="twitter:creator" content="@OmnySports" />
  <meta property="twitter:card" content="summary_large_image" />
  <meta property="twitter:url" content={canonicalURL} />
  <meta property="twitter:title" content={meta.metaTitle} />
  <meta property="twitter:description" content={meta.description} />
  <meta property="twitter:image" content={OGImage} />
  <meta property="twitter:image:alt" content={meta.ogImageAlt} />

  {
    isArticleMeta(meta) ? (
      <>
        <meta
          property="article:published_time"
          content={new Date(meta.publishedTime).toISOString()}
        />
        <meta
          property="article:modified_time"
          content={new Date(meta.lastModified).toISOString()}
        />
        {(meta as any).category?.[0] && <meta property="article:section" content={(meta as any).category[0]} />}
        {meta.keywords && meta.keywords.split(",").map(tag => (
          <meta property="article:tag" content={tag.trim()} />
        ))}

        {meta.authors.map((author) => (
          <>
            <meta property="author" content={author.name} />
            <meta
              property="article:author"
              content={`${Astro.site}authors/${author.link}`}
            />
          </>
        ))}
      </>
    ) : null
  }

  {/* Technical SEO: Pagination Relations */}
  {meta.prev && <link rel="prev" href={new URL(meta.prev, Astro.site).href} />}
  {meta.next && <link rel="next" href={new URL(meta.next, Astro.site).href} />}


  <!-- Speculation Rules API - Refined for Intent & Psychology -->
  <script type="speculationrules" is:inline>
    {
      "prerender": [
        {
          "where": {
            "and": [
              { "href_matches": "/*" },
              { "not": { "href_matches": "/admin/*" } },
              { "not": { "href_matches": "/keystatic/*" } },
              { "not": { "selector_matches": "[data-no-prerender]" } }
            ]
          },
          "eagerness": "moderate"
        }
      ],
      "prefetch": [
        {
          "where": {
            "and": [
              { "href_matches": "/*" },
              { "not": { "href_matches": "/admin/*" } },
              { "not": { "href_matches": "/keystatic/*" } }
            ]
          },
          "eagerness": "conservative"
        }
      ]
    }
  </script>

  <script type="application/ld+json" set:html={schemaOrgString} />
  {breadcrumbSchemaString && <script type="application/ld+json" set:html={breadcrumbSchemaString} />}

  {/* Extreme SEO: SearchAction (Homepage only) */}
  {Astro.url.pathname === "/" && (
    <script type="application/ld+json">
      {JSON.stringify({
        "@context": "https://schema.org",
        "@type": "WebSite",
        "url": Astro.site,
        "potentialAction": {
          "@type": "SearchAction",
          "target": `${Astro.site}search?q={search_term_string}`,
          "query-input": "required name=search_term_string"
        }
      })}
    </script>
  )}

  <ClientRouter />
</head>
